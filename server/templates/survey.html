<!doctype html>
{% include "navbar.html" %}
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='survey.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/4.4.0/font/octicons.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script type="text/javascript">
    function updateShowPhenomena() {
        if (document.getElementById('shows_phenomena_true').checked) {
            document.getElementById('phenomena_desc').style.display = 'block';
        } else {
            document.getElementById('phenomena_desc').style.display = 'none';
        }
    }

    window.onload = function() {
        updateShowPhenomena();

        var options = document.getElementsByClassName('mainBox');
        for (option of options) {
            updateOptionIcon(option);
        }

        var subLists = document.querySelectorAll('ul.subList');
        subLists.forEach(subList => {
            var shouldBeVisible = false;
            var subOptionChildren = subList.querySelectorAll('input.subOption');
            for (subOption of subOptionChildren) {
                updateSuboptionIcon(subOption);
            }
            for (subOption of subOptionChildren) {
                if (subOption.checked == true) {
                    shouldBeVisible = true;
                    break; //return from inner loop
                }
            }
            if (!shouldBeVisible) {
                subList.style.display = 'none';
            }
        });

    };

    function updateOptionIcon(elem) {
        var siblings = getSiblings(elem);
        for (s of siblings) {
            if (s.tagName == 'LABEL') {
                var octicons = s.getElementsByClassName('octicon');
                if (elem.checked) {
                    setOcticonsChecked(octicons);
                } else {
                    setOcticonsUnchecked(octicons);
                }
            }
        }
    }

    function optionClicked(elem) {
        updateOptionIcon(elem);
        var siblings = getSiblings(elem);
        for (s of siblings) {
            if (s.tagName != 'LABEL') {
                if (elem.checked) {
                    s.style.display = 'block';
                } else {
                    s.style.display = 'none';
                    s.querySelectorAll('input.subOption').forEach(subOpt => {
                        subOpt.checked = false;
                        updateSuboptionIcon(subOpt)
                    })
                }
            }
        }
    }

    function setOcticonsChecked(octicons) {
        for (octicon of octicons) {
            if (octicon.classList.contains("octicon-chevron-right")) {
                octicon.classList.remove("octicon-chevron-right");
                octicon.classList.add("octicon-chevron-down");
            } else if (octicon.classList.contains("octicon-x")) {
                octicon.classList.remove("octicon-x");
                octicon.classList.add("octicon-check");
            }
        }
    }

    function setOcticonsUnchecked(octicons) {
        for (octicon of octicons) {
            if (octicon.classList.contains("octicon-chevron-down")) {
                octicon.classList.remove("octicon-chevron-down");
                octicon.classList.add("octicon-chevron-right");
            } else if (octicon.classList.contains("octicon-check")) {
                octicon.classList.remove("octicon-check");
                octicon.classList.add("octicon-x");
            }
        }
    }

    function updateSuboptionIcon(elem) {
        if (elem.checked === true) {
            var octicons = elem.parentElement.getElementsByClassName('octicon');
            setOcticonsChecked(octicons);
        } else {
            var octicons = elem.parentElement.getElementsByClassName('octicon');
            setOcticonsUnchecked(octicons)
        }
    }

    function getSiblings (elem) {
        var siblings = [];
        var sibling = elem.parentNode.firstChild;
        for (; sibling; sibling = sibling.nextSibling) {
            if (sibling.nodeType !== 1 || sibling === elem) continue;
            siblings.push(sibling);
        }
        return siblings;
    };
</script>
<style type="text/css">
    ul {
        list-style: none;
    }

    input[type='checkbox'] {
        margin-right: 5px;
    }

    li.category {
        font-style: italic;
    }

    input.mainBox {
        display: none;
    }

    input.subOption {
        display: none;
    }
</style>
<div class="main container">

    <h1>{{ model }}/{{ layer }}/{{ unit }}</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/home/{{ name }}">home</a></li>
            <li class="breadcrumb-item"><a href="/overview/{% if full %}full/{% endif %}{% if ranked %}ranked/{% endif %}{{ name }}/{{ model }}/{{ layer }}#{{ unit }}">{{ layer }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ unit }}</li>
        </ol>
    </nav>

    <h2>Instructions</h2>
    <p>
        1. Please inspect the highlighted areas within the images on this page, then answer the survey questions below.<br>
        2. The survey questions pertain only to the images shown on this page.<br>
        3. The images show different mammography scans.<br>
        4. <b>You must click on the submit button under the survey questions to save your responses.</b> After your responses are saved, you will be taken back to the previous page.<br>
    </p>

    <h2>Survey</h2>
    <p>Are there ANY recognizable phenomena among the highlighted parts in the pictures?</p>
    <div class="container">
        <div class="row">
            <div class="col-4">
                <form action="{{ url_for('handle_survey') }}{% if full %}/full{% endif %}{% if ranked %}/ranked{% endif %}" method="post">
                    <input type="hidden" name="name" value="{{ name }}">
                    <input type="hidden" name="model" value="{{ model }}">
                    <input type="hidden" name="layer" value="{{ layer }}">
                    <input type="hidden" name="unit" value="{{ unit }}">
                    <p>
                        <label>
                            <input id="shows_phenomena_false" name="shows_phenomena" type="radio" onclick="javascript:updateShowPhenomena();" value="false" {% if shows_phenomena == "false" %} checked {% endif %}/>
                            <span>No recognizable phenomena present</span>
                        </label>
                    </p>
                    <p>
                        <label>
                            <input id="shows_phenomena_true" name="shows_phenomena" type="radio" onclick="javascript:updateShowPhenomena();" value="true" {% if shows_phenomena == "true" %} checked {% endif %}/>
                            <span>Recognizable phenomena are present</span>
                        </label>
                    </p>
                    <div id="phenomena_desc" class="phenomena_desc">
                        <ul>
                            <li>
                                <input type="checkbox" class="mainBox" id="mass_box" onclick="optionClicked(this)" name="phe_mass" {% if phe_mass %} checked {% endif %}><label for="mass_box" class="mainCategory"><i class="octicon octicon-chevron-right"></i>Herdläsion</label>
                                <ul class="subList">
                                    <li class="category">Form</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_mass_oval" {% if phe_mass_oval %} checked {% endif %}><i class="octicon octicon-x"></i>Oval</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_mass_round" {% if phe_mass_round %} checked {% endif %}><i class="octicon octicon-x"></i>Rund</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_mass_irregular" {% if phe_mass_irregular %} checked {% endif %}><i class="octicon octicon-x"></i>Unregelmäßig</label></li>
                                </ul>
                                <ul class="subList">
                                    <li class="category">Rand</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_margin_circumscribed" {% if phe_margin_circumscribed %} checked {% endif %}><i class="octicon octicon-x"></i>Umschrieben</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_margin_obscured" {% if phe_margin_obscured %} checked {% endif %}><i class="octicon octicon-x"></i>Verdeckt</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_margin_microlobulated" {% if phe_margin_microlobulated %} checked {% endif %}><i class="octicon octicon-x"></i>Mikrobuliert</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_margin_spiculated" {% if phe_margin_spiculated %} checked {% endif %}><i class="octicon octicon-x"></i>Spikuliert</label></li>
                                </ul>
                                <ul class="subList">
                                    <li class="category">Dichte</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_density_high" {% if phe_density_high %} checked {% endif %}><i class="octicon octicon-x"></i>Hoch</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_density_equal" {% if phe_density_equal %} checked {% endif %}><i class="octicon octicon-x"></i>Gleich</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_density_low" {% if phe_density_low %} checked {% endif %}><i class="octicon octicon-x"></i>Gering</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_density_fat" {% if phe_density_fat %} checked {% endif %}><i class="octicon octicon-x"></i>Fetthaltig</label></li>
                                </ul>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="calcBox" onclick="optionClicked(this)" name="phe_calc" {% if phe_calc %} checked {% endif %}><label for="calcBox" class="mainCategory"><i class="octicon octicon-chevron-right"></i>Verkalkung</label>
                                <ul class="subList">
                                    <li class="category">Verteilung</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_distribution_diffuse" {% if phe_distribution_diffuse %} checked {% endif %}><i class="octicon octicon-x"></i>Diffus</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_distribution_regional" {% if phe_distribution_regional %} checked {% endif %}><i class="octicon octicon-x"></i>Regional</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_distribution_grouped" {% if phe_distribution_grouped %} checked {% endif %}><i class="octicon octicon-x"></i>Gruppiert</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_distribution_linear" {% if phe_distribution_linear %} checked {% endif %}><i class="octicon octicon-x"></i>Linear</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_distribution_segmental" {% if phe_distribution_segmental %} checked {% endif %}><i class="octicon octicon-x"></i>Segmental</label></li>
                                </ul>
                                <ul class="subList">
                                    <li class="category">Form</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_vascular" {% if phe_type_vascular %} checked {% endif %}><i class="octicon octicon-x"></i>Gefäßverkalkung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_skin" {% if phe_type_skin %} checked {% endif %}><i class="octicon octicon-x"></i>Hautverkalkung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_popcorn" {% if phe_type_popcorn %} checked {% endif %}><i class="octicon octicon-x"></i>Popcorn-Verkalkung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_round" {% if phe_type_round %} checked {% endif %}><i class="octicon octicon-x"></i>Runde Verkalkung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_rim" {% if phe_type_rim %} checked {% endif %}><i class="octicon octicon-x"></i>Randverkalkung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_dystrophic" {% if phe_type_dystrophic %} checked {% endif %}><i class="octicon octicon-x"></i>Dystroph</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_suture" {% if phe_type_suture %} checked {% endif %}><i class="octicon octicon-x"></i>Nahtmaterial</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_amorphous" {% if phe_type_amorphous %} checked {% endif %}><i class="octicon octicon-x"></i>Amorph</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_type_courseheterogenous" {% if phe_type_courseheterogenous %} checked {% endif %}><i class="octicon octicon-x"></i>Grob heterogen</label></li>
                                </ul>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="distorsion_box" onclick="optionClicked(this)" name="phe_architectural_distorsion" {% if phe_architectural_distorsion %} checked {% endif %}><label for="distorsion_box" class="mainCategory"><i class="octicon octicon-x"></i>Architekturzerstörungen</label>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="asym_box" onclick="optionClicked(this)" name="phe_asymmetries" {% if phe_asymmetries %} checked {% endif %}><label for="asym_box" class="mainCategory"><i class="octicon octicon-chevron-right"></i>Asymetrien</label>
                                <ul class="subList">
                                    <li class="category">Typ</li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_asymetry_global" {% if phe_asymetry_global %} checked {% endif %}><i class="octicon octicon-x"></i>Global</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)"name="phe_asymetry_focal" {% if phe_asymetry_focal %} checked {% endif %}><i class="octicon octicon-x"></i>Fokal</label></li>
                                </ul>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="skinlesion_box" onclick="optionClicked(this)" name="phe_skinlesion" {% if phe_skinlesion %} checked {% endif %}><label for="skinlesion_box" class="mainCategory"><i class="octicon octicon-x"></i>Hautläsion</label>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="milkduct_box" onclick="optionClicked(this)" name="phe_milkduct" {% if phe_milkduct %} checked {% endif %}><label for="milkduct_box" class="mainCategory"><i class="octicon octicon-x"></i>Einzelner erweiterter Milchgang</label>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="lymphnode_box" onclick="optionClicked(this)" name="phe_intramammarylymphnode" {% if phe_intramammarylymphnode %} checked {% endif %}><label for="lymphnode_box" class="mainCategory"><i class="octicon octicon-x"></i>Intramammärer Lymphknoten</label>
                            </li>

                            <li>
                                <input type="checkbox" class="mainBox" id="epi_box" onclick="optionClicked(this)" name="phe_epiphenomenon" {% if phe_epiphenomenon %} checked {% endif %}><label for="epi_box" class="mainCategory"><i class="octicon octicon-chevron-right"></i>Begleiterscheinungen</label>
                                <ul class="subList">
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_skinretraction" {% if phe_skinretraction %} checked {% endif %}><i class="octicon octicon-x"></i>Hautretraktion</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_mamillaryretraction" {% if phe_mamillaryretraction %} checked {% endif %}><i class="octicon octicon-x"></i>Mamillenretraktion</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_skinthickening" {% if phe_skinthickening %} checked {% endif %}><i class="octicon octicon-x"></i>Hautverdickung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_trabeculary" {% if phe_trabeculary %} checked {% endif %}><i class="octicon octicon-x"></i>Trabekuläre Verdichtung</label></li>
                                    <li><label><input type="checkbox" class="subOption" onclick="updateSuboptionIcon(this)" name="phe_axillary" {% if phe_axillary %} checked {% endif %}><i class="octicon octicon-x"></i>Auxiläre Verdichtung</label></li>
                                </ul>

                            </li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-primary">Senden</button>
                </form>
            </div>
            <div class="col-8">
                {% for i in range(top_images|length) %}
                    <a href="/image/{{ top_images[i] }}" style="display: inline-block; margin: 0px 5px 10px 5px;">
                        <div style="
                                height: 200px; width: 160px;
                                background-image: url({{ "/" + preprocessed_top_images[i] }}), url({{ "/" + activation_maps[i] }});
                                background-blend-mode: screen;
                                background-size: contain;
                                background-repeat: no-repeat;">
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>






</div>
